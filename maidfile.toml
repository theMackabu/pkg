[env]
patch_dir = "../patches"
branch = "release/v1.22"
repo = "https://github.com/go-gitea/gitea"
commit = "16e51e91a1fdca1d42ea0d464c33bf7b2ca76266"

[project]
name = "pkg.ci"
version = "0.2.1"

[tasks]
clean.script = "rm -rf gitea"
reset.script = "bash -c 'git reset --hard HEAD && git clean -fd'"
clone.script = ["maid clean -q", "git clone -b %{env.branch} --single-branch %{env.repo}", "git checkout %{env.commit}"]

[tasks.patch]
path = "gitea"
script = [
  "git apply --reject --whitespace=nowarn %{env.patch_dir}/gitea.patch",
  "git apply --reject --whitespace=nowarn %{env.patch_dir}/navbar.patch"
]

[tasks.build]
path = "gitea"
depends = ["patch"]
script = "bash -c 'TAGS=\"bindata sqlite sqlite_unlock_notify\" make build'"

[tasks.install]
path = "gitea"
script = ["service gitea stop", "cp gitea /home/gitea", "service gitea start", "rm gitea"]
